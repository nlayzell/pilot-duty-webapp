<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilot Duty Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to compile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-900">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, Timestamp, setDoc, getDoc, where, getDocs, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // This makes Firebase functions available to the main React script
        window.firebase = {
            initializeApp,
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            getFirestore,
            collection,
            addDoc,
            query,
            onSnapshot,
            doc,
            Timestamp,
            setDoc,
            getDoc,
            where,
            getDocs,
            orderBy,
            setLogLevel
        };
    </script>

    <!-- Your React Application Code -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // --- BEGIN Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBj6LK7FIgolevRztQ4z78YY4d9F1dlDyg",
          authDomain: "flight-duty-tracker-fbeae.firebaseapp.com",
          projectId: "flight-duty-tracker-fbeae",
          storageBucket: "flight-duty-tracker-fbeae.firebasestorage.app", 
          messagingSenderId: "430097302817",
          appId: "1:430097302817:web:ed0594f45931dc84dc6a60",
          measurementId: "G-9BTKL71S9E" 
        };
        // --- END Firebase Configuration ---

        // --- BEGIN Proxy API Configuration ---
        const API_BASE_URL = "https://flight-duty-proxy.onrender.com"; 
        // --- END Proxy API Configuration ---

        // --- BEGIN Duty Regulation Constants ---
        const MAX_FLIGHT_TIME_28_DAYS = 112; 
        const MAX_FLIGHT_TIME_90_DAYS = 300; 
        const MAX_FLIGHT_TIME_365_DAYS = 1000; 
        const MIN_REST_AWAY_FROM_BASE = 10;
        const MIN_REST_AT_HOME_BASE = 12; 
        // --- END Duty Regulation Constants ---

        // --- Helper Functions ---
        const formatDateTime = (date) => {
          if (!date) return 'N/A';
          if (date.toDate) {
            return date.toDate().toLocaleString('en-CA', { dateStyle: 'medium', timeStyle: 'short' });
          }
          return new Date(date).toLocaleString('en-CA', { dateStyle: 'medium', timeStyle: 'short' });
        };

        const formatDate = (date) => {
            if (!date) return 'N/A';
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const getMaxFDP = (startTimeISO, numFlights) => {
            const hour = new Date(startTimeISO).getHours();
            let maxFDP = 9; 
            if (hour >= 0 && hour < 4) maxFDP = 9;
            else if (hour >= 4 && hour < 5) maxFDP = (numFlights <= 4) ? 10 : 9;
            else if (hour >= 5 && hour < 6) maxFDP = (numFlights <= 4) ? 11 : (numFlights <= 6) ? 10 : 9;
            else if (hour >= 6 && hour < 7) maxFDP = (numFlights <= 4) ? 12 : (numFlights <= 6) ? 11 : 10;
            else if (hour >= 7 && hour < 13) maxFDP = (numFlights <= 4) ? 13 : (numFlights <= 6) ? 12 : 11;
            else if (hour >= 13 && hour < 17) maxFDP = (numFlights <= 4) ? 12.5 : (numFlights <= 6) ? 11.5 : 10.5;
            else if (hour >= 17 && hour < 22) maxFDP = (numFlights <= 4) ? 12 : (numFlights <= 6) ? 11 : 10;
            else if (hour >= 22 && hour < 23) maxFDP = (numFlights <= 4) ? 11 : (numFlights <= 6) ? 10 : 9;
            else if (hour >= 23 && hour < 24) maxFDP = (numFlights <= 4) ? 10 : 9;
            return maxFDP;
        };

        const LoginScreen = ({ auth, setError, error }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async () => {
                const { signInWithEmailAndPassword } = window.firebase;
                setIsLoading(true);
                setError('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    setError("Login failed: Invalid email or password.");
                } finally {
                    setIsLoading(false);
                }
            };
            
            return (
                <div className="flex items-center justify-center min-h-screen">
                    <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-xl shadow-2xl">
                        <div>
                            <h2 className="text-3xl font-bold text-center text-sky-400">Pilot Duty Tracker</h2>
                            <p className="mt-2 text-center text-sm text-slate-400">Please sign in</p>
                        </div>
                        {error && <div className="bg-red-500/20 text-red-300 p-3 rounded-lg text-center">{error}</div>}
                        <div className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-slate-300">Email address</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-white shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"/>
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-slate-300">Password</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-white shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"/>
                            </div>
                            <button onClick={handleLogin} disabled={isLoading} className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 disabled:opacity-50">
                                {isLoading ? 'Signing In...' : 'Sign In'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [user, setUser] = useState(null);
          const [isAuthReady, setIsAuthReady] = useState(false);
          const [pilots, setPilots] = useState([]);
          const [currentPilotId, setCurrentPilotId] = useState('');
          const [newPilotName, setNewPilotName] = useState('');
          const [flightEntries, setFlightEntries] = useState([]);
          const getInitialStartDate = () => {
              const date = new Date();
              date.setDate(date.getDate() - 7);
              return formatDate(date);
          };
          const [apiFromDate, setApiFromDate] = useState(getInitialStartDate());
          const [apiToDate, setApiToDate] = useState(formatDate(new Date()));
          const [isLoading, setIsLoading] = useState(true); 
          const [error, setError] = useState('');
          const [showAddPilotModal, setShowAddPilotModal] = useState(false);
          const [showDutyModal, setShowDutyModal] = useState(false);
          const [showDetailsModal, setShowDetailsModal] = useState(false); 
          const [selectedFlightDetails, setSelectedFlightDetails] = useState(null);
          const [isApiLoading, setIsApiLoading] = useState(false); 
          const [apiMessage, setApiMessage] = useState(''); 
          const [complianceMessage, setComplianceMessage] = useState('');
          const [legalityResult, setLegalityResult] = useState(null);
          const [isCheckingLegality, setIsCheckingLegality] = useState(false);
          const [dashboardData, setDashboardData] = useState([]);

          // Form States
          const [proposedDutyDate, setProposedDutyDate] = useState(formatDate(new Date()));
          const [proposedStartTime, setProposedStartTime] = useState('09:00');
          const [proposedEndTime, setProposedEndTime] = useState('17:00');
          const [proposedFlightTime, setProposedFlightTime] = useState('6');
          const [proposedNumFlights, setProposedNumFlights] = useState('2');
          const [dutyDate, setDutyDate] = useState(formatDate(new Date()));
          const [dutyStartTime, setDutyStartTime] = useState('08:00');
          const [dutyEndTime, setDutyEndTime] = useState('16:00');
          const [flightTimeHours, setFlightTimeHours] = useState('5'); 
          const [numFlightsInDuty, setNumFlightsInDuty] = useState('2');

          useEffect(() => {
            const { initializeApp, getAuth, onAuthStateChanged, getFirestore, setLogLevel } = window.firebase;
            
            setLogLevel('debug'); 
            const app = initializeApp(firebaseConfig);
            const firestoreDb = getFirestore(app);
            const firebaseAuth = getAuth(app);
            setDb(firestoreDb);
            setAuth(firebaseAuth);

            const unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
              setUser(user); 
              setIsAuthReady(true); 
              setIsLoading(false); 
            });
            return () => unsubscribe();
          }, []);

          useEffect(() => {
            if (!db || !isAuthReady || !user) return;

            const { collection, query, orderBy, onSnapshot, getDocs } = window.firebase;

            const pilotsColPath = "pilots";
            const pilotsQuery = query(collection(db, pilotsColPath), orderBy("name"));
            const unsubscribePilots = onSnapshot(pilotsQuery, async (pilotsSnapshot) => {
              const pilotsData = pilotsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setPilots(pilotsData);

              if (pilotsData.length > 0) {
                 if (!currentPilotId || !pilotsData.find(p => p.id === currentPilotId)) {
                    setCurrentPilotId(pilotsData[0].id);
                 }
                
                 const dashboardStats = [];
                 for (const pilot of pilotsData) {
                    const entriesColPath = `pilots/${pilot.id}/flightEntries`;
                    const entriesQuery = query(collection(db, entriesColPath));
                    const entriesSnapshot = await getDocs(entriesQuery);
                    const allPilotEntries = entriesSnapshot.docs.map(d => d.data());
                    
                    const now = new Date();
                    const lookbackPeriods = [
                        { days: 28, limit: MAX_FLIGHT_TIME_28_DAYS },
                        { days: 90, limit: MAX_FLIGHT_TIME_90_DAYS },
                        { days: 365, limit: MAX_FLIGHT_TIME_365_DAYS }
                    ];

                    const stats = { pilotId: pilot.id, name: pilot.name };
                    lookbackPeriods.forEach(period => {
                        const startDate = new Date(now);
                        startDate.setDate(now.getDate() - period.days);
                        const totalHours = allPilotEntries
                            .filter(entry => entry.dutyStartTimestamp.toDate() >= startDate)
                            .reduce((sum, entry) => sum + (entry.flightTimeHours || 0), 0);
                        stats[`total${period.days}`] = totalHours;
                    });
                    dashboardStats.push(stats);
                 }
                 setDashboardData(dashboardStats);

              } else {
                setCurrentPilotId(''); 
                setDashboardData([]);
              }
            }, (err) => { setError("Failed to load pilot data for dashboard."); });

            return () => unsubscribePilots();
          }, [db, isAuthReady, user]);

          useEffect(() => {
            if (!db || !currentPilotId || !isAuthReady || !user) {
              setFlightEntries([]); 
              return;
            }
            const { collection, query, orderBy, onSnapshot } = window.firebase;
            const entriesColPath = `pilots/${currentPilotId}/flightEntries`;
            const entriesQuery = query(collection(db, entriesColPath), orderBy("dutyStartTimestamp", "desc"));
            const unsubscribeEntries = onSnapshot(entriesQuery, (snapshot) => {
              const entriesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setFlightEntries(entriesData);
            }, (err) => { setError("Failed to load flight entries for selected pilot."); });
            return () => unsubscribeEntries();
          }, [db, currentPilotId, isAuthReady, user]);
          
          const handleAddPilot = async (pilotName, pilotIdentifier) => {
              const { doc, setDoc, Timestamp } = window.firebase;
              if (!db || !pilotName.trim()) {
                setError("Pilot name cannot be empty.");
                return null;
              }
              const pilotsColPath = "pilots";
              try {
                const docId = pilotIdentifier || pilotName.replace(/\s+/g, '-').toLowerCase();
                const pilotRef = doc(db, pilotsColPath, docId);
                await setDoc(pilotRef, { name: pilotName.trim(), foreflightId: pilotIdentifier || null, createdAt: Timestamp.now() }, { merge: true });
                setError('');
                return pilotRef.id;
              } catch (err) {
                setError("Failed to add pilot. " + err.message);
                return null;
              }
          };
          
          const handleManualAddPilot = async () => {
            setIsLoading(true);
            const newId = await handleAddPilot(newPilotName, null);
            if(newId) {
                setNewPilotName('');
                setShowAddPilotModal(false);
                setCurrentPilotId(newId);
            }
            setIsLoading(false);
          };

          const handleSignOut = async () => {
              const { signOut } = window.firebase;
              try {
                  await signOut(auth);
              } catch (error) {
                  setError("Failed to sign out.");
              }
          };
          
          const processAndStoreFlightEntry = async (flightData, pilotIdToLink, entrySource = 'api') => {
            const { collection, addDoc } = window.firebase;
            try {
              const entriesColPath = `pilots/${pilotIdToLink}/flightEntries`;
              await addDoc(collection(db, entriesColPath), { ...flightData, source: entrySource });
            } catch (err) {
              setError(`Failed to save flight entry for pilot ${pilotIdToLink}.`);
            }
          };

          const fetchAndProcessFlightsFromAPI = async () => {
            const { Timestamp, collection, where, getDocs, query: firestoreQuery, doc, getDoc } = window.firebase;
            setIsApiLoading(true);
            setApiMessage("Fetching flights...");
            setError('');
            const endpoint = `${API_BASE_URL}/api/flights`;
            const fromDateUTC = new Date(apiFromDate).toISOString();
            const toDateUTC = new Date(new Date(apiToDate).setHours(23, 59, 59, 999)).toISOString();

            try {
              const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fromDate: fromDateUTC, toDate: toDateUTC })
              });
              const responseData = await response.json();
              if (!response.ok) throw new Error(responseData.details || responseData.message || 'Unknown proxy error');
              
              const flightsToProcess = responseData.flights || [];
              if (flightsToProcess.length === 0) {
                setApiMessage("Successfully fetched, but no flights found in the date range.");
                setIsApiLoading(false);
                return;
              }

              let processedCount = 0;
              let newPilotsAdded = 0;
              for (const flight of flightsToProcess) {
                if (!flight.crew || flight.crew.length === 0) continue;

                const dutyStartStr = flight.flightLogTime?.timeOut || flight.departureTime;
                const dutyEndStr = flight.flightLogTime?.timeIn || flight.arrivalTime;
                if (!dutyStartStr || !dutyEndStr) continue;

                const dutyStartTimestamp = Timestamp.fromDate(new Date(dutyStartStr));
                const dutyEndTimestamp = Timestamp.fromDate(new Date(dutyEndStr));
                if (dutyStartTimestamp.toMillis() >= dutyEndTimestamp.toMillis()) continue;
                
                const dutyPeriodHours = (dutyEndTimestamp.toMillis() - dutyStartTimestamp.toMillis()) / (1000 * 60 * 60);
                let flightTimeH = flight.flightLogTime?.flight || dutyPeriodHours - 0.5;
                if(flightTimeH < 0) flightTimeH = 0;

                const apiEntry = {
                  dutyStartTimestamp,
                  dutyEndTimestamp,
                  flightTimeHours: parseFloat(flightTimeH.toFixed(2)),
                  dutyPeriodHours: parseFloat(dutyPeriodHours.toFixed(2)),
                  numFlightsInDuty: flight.legs?.length || 1,
                  createdAt: Timestamp.now(),
                  foreFlightId: flight.flightId || null,
                  details: `Flight ${flight.aircraftRegistration} from ${flight.departure} to ${flight.destination}`
                };
                
                for (const crewMember of flight.crew) {
                  const pilotIdentifier = crewMember.crewId;
                  if(!pilotIdentifier) continue;

                  const pilotRef = doc(db, `pilots`, pilotIdentifier);
                  const pilotSnap = await getDoc(pilotRef);

                  if (!pilotSnap.exists()) {
                      await handleAddPilot(pilotIdentifier, pilotIdentifier);
                      newPilotsAdded++;
                  }

                  const entriesColPath = `pilots/${pilotIdentifier}/flightEntries`;
                  let shouldAddEntry = true;
                  if(apiEntry.foreFlightId) {
                    const q = firestoreQuery(collection(db, entriesColPath), where("foreFlightId", "==", apiEntry.foreFlightId));
                    const existingSnapshot = await getDocs(q);
                    if (!existingSnapshot.empty) {
                      shouldAddEntry = false;
                    }
                  }
                  
                  if (shouldAddEntry) {
                    await processAndStoreFlightEntry(apiEntry, pilotIdentifier, 'api');
                    processedCount++;
                  }
                }
              }
              let finalMessage = `Sync complete. Processed ${processedCount} new flight log entries.`;
              if (newPilotsAdded > 0) {
                finalMessage += ` Added ${newPilotsAdded} new pilot(s).`
              }
              setApiMessage(finalMessage);
            } catch (err) {
              setApiMessage(`Error: ${err.message}`);
              setError(`API Error: ${err.message}`);
            } finally {
              setIsApiLoading(false);
            }
          };
          
          const handleManualFormSubmit = async (e) => {
            e.preventDefault();
            setIsLoading(true);
            const { Timestamp } = window.firebase;
            const dutyStartTimestamp = Timestamp.fromDate(new Date(`${dutyDate}T${dutyStartTime}`));
            let dutyEndTimestamp = Timestamp.fromDate(new Date(`${dutyDate}T${dutyEndTime}`));
            if (dutyEndTimestamp.toMillis() <= dutyStartTimestamp.toMillis()) {
                const nextDay = new Date(dutyDate);
                nextDay.setDate(nextDay.getDate() + 1);
                dutyEndTimestamp = Timestamp.fromDate(new Date(`${formatDate(nextDay)}T${dutyEndTime}`));
            }
            const flightTime = parseFloat(flightTimeHours);
            const numFlights = parseInt(numFlightsInDuty, 10);
            const dutyPeriodHours = (dutyEndTimestamp.toMillis() - dutyStartTimestamp.toMillis()) / (1000 * 60 * 60);

            const newEntry = {
              dutyStartTimestamp,
              dutyEndTimestamp,
              flightTimeHours: flightTime,
              dutyPeriodHours: parseFloat(dutyPeriodHours.toFixed(2)),
              numFlightsInDuty: numFlights, 
              createdAt: Timestamp.now(),
              details: "Manual Entry"
            };

            await processAndStoreFlightEntry(newEntry, currentPilotId, 'manual');
            setShowDutyModal(false);
            setIsLoading(false);
          };
          
          const handleViewDetails = async (flightId) => {
              if (!flightId) { return; }
              setIsApiLoading(true);
              setSelectedFlightDetails(null); 
              setShowDetailsModal(true); 
              
              const endpoint = `${API_BASE_URL}/api/flight-details/${flightId}`;
              try {
                  const response = await fetch(endpoint);
                  const data = await response.json();
                  if(!response.ok) throw new Error(data.details || data.message || "Failed to fetch details");
                  setSelectedFlightDetails(data);
              } catch (err) {
                  setError(`Could not fetch details for flight ${flightId}: ${err.message}`);
                  setSelectedFlightDetails({ error: `Could not fetch details. ${err.message}` });
              } finally {
                  setIsApiLoading(false);
              }
          };

          const handleLegalityCheck = async () => {
            const { collection, getDocs, query: firestoreQuery } = window.firebase;
            if(!currentPilotId) return;
            setIsCheckingLegality(true);
            setLegalityResult(null);
            setError('');

            try {
                const entriesColPath = `pilots/${currentPilotId}/flightEntries`;
                const entriesQuery = firestoreQuery(collection(db, entriesColPath));
                const snapshot = await getDocs(entriesQuery);
                const pastEntries = snapshot.docs.map(doc => doc.data());

                const proposedStart = new Date(`${proposedDutyDate}T${proposedStartTime}`);
                const proposedEnd = new Date(`${proposedDutyDate}T${proposedEndTime}`);
                if(proposedEnd <= proposedStart) proposedEnd.setDate(proposedEnd.getDate() + 1);
                
                const proposedFDP = (proposedEnd - proposedStart) / (1000 * 60 * 60);
                const proposedFT = parseFloat(proposedFlightTime);
                const proposedFlights = parseInt(proposedNumFlights, 10);
                
                let results = [];

                const lastFlight = pastEntries.sort((a,b) => b.dutyEndTimestamp.toMillis() - a.dutyEndTimestamp.toMillis())[0];
                if (lastFlight) {
                    const restInMillis = proposedStart.getTime() - lastFlight.dutyEndTimestamp.toDate().getTime();
                    const restInHours = restInMillis / (1000 * 60 * 60);
                    if(restInHours < MIN_REST_AWAY_FROM_BASE) {
                        results.push({ check: "Minimum Rest", status: "VIOLATION", details: `Required: ${MIN_REST_AWAY_FROM_BASE}h, Actual: ${restInHours.toFixed(1)}h`});
                    } else {
                        results.push({ check: "Minimum Rest", status: "OK", details: `${restInHours.toFixed(1)}h rest is sufficient.`});
                    }
                } else {
                    results.push({ check: "Minimum Rest", status: "OK", details: "No previous flights found."});
                }
                
                const maxFDP = getMaxFDP(proposedStart.toISOString(), proposedFlights);
                if(proposedFDP > maxFDP) {
                     results.push({ check: "Max FDP", status: "VIOLATION", details: `Proposed FDP: ${proposedFDP.toFixed(1)}h, Max Allowed: ${maxFDP}h`});
                } else {
                     results.push({ check: "Max FDP", status: "OK", details: `Proposed FDP: ${proposedFDP.toFixed(1)}h, Max Allowed: ${maxFDP}h`});
                }

                const lookbackPeriods = [
                    { days: 28, limit: MAX_FLIGHT_TIME_28_DAYS },
                    { days: 90, limit: MAX_FLIGHT_TIME_90_DAYS },
                    { days: 365, limit: MAX_FLIGHT_TIME_365_DAYS }
                ];

                for (const period of lookbackPeriods) {
                    const startDate = new Date(proposedStart);
                    startDate.setDate(startDate.getDate() - period.days);
                    
                    const totalPastHours = pastEntries
                        .filter(entry => entry.dutyStartTimestamp.toDate() >= startDate && entry.dutyStartTimestamp.toDate() < proposedStart)
                        .reduce((sum, entry) => sum + (entry.flightTimeHours || 0), 0);
                    
                    const futureTotal = totalPastHours + proposedFT;

                    if (futureTotal > period.limit) {
                        results.push({ check: `${period.days}-Day Flight Time`, status: "VIOLATION", details: `Projected Total: ${futureTotal.toFixed(1)}h, Limit: ${period.limit}h` });
                    } else {
                        results.push({ check: `${period.days}-Day Flight Time`, status: "OK", details: `Projected Total: ${futureTotal.toFixed(1)}h, Limit: ${period.limit}h` });
                    }
                }
                
                setLegalityResult(results);
            } catch(err) { setError("Failed to check legality.");}
            finally { setIsCheckingLegality(false); }
          };

          if (!isAuthReady) {
              return <div className="flex items-center justify-center min-h-screen text-white">Loading...</div>;
          }

          if (!user) {
              return <LoginScreen auth={auth} setUserId={(uid) => setUser({uid})} setError={setError} error={error} />;
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-slate-100 font-sans p-4 md:p-8">
              <header className="mb-8 text-center relative">
                <h1 className="text-4xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-500">Automated Duty Tracker</h1>
                <p className="text-slate-400 text-sm mt-1">Logged in as: {user.email}</p>
                <div className="absolute top-0 right-0">
                    <button onClick={handleSignOut} className="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md">
                        Sign Out
                    </button>
                </div>
              </header>
              {error && <div className="bg-red-700/30 border border-red-500 text-red-300 px-4 py-3 rounded-lg mb-6"><strong className="font-bold">Error: </strong><span className="block sm:inline">{error}</span></div>}
              {apiMessage && <div className={`px-4 py-3 rounded-lg mb-6 ${apiMessage.includes("Error") || apiMessage.includes("failed") ? 'bg-red-700/30 border-red-500 text-red-300' : 'bg-blue-700/30 border-blue-500 text-blue-300'}`}><strong className="font-bold">API Status: </strong><span className="block sm:inline">{apiMessage}</span></div>}
              
              <div className="mb-6 p-6 bg-slate-800 rounded-xl shadow-2xl space-y-4">
                <h2 className="text-xl font-semibold text-center text-sky-400">Proposed Flight Legality Check</h2>
                {/* ... Legality check UI */}
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div className="p-6 bg-slate-800 rounded-xl shadow-2xl">
                  <h2 className="text-xl font-semibold mb-4 text-sky-400">Manage Pilots</h2>
                  {/* ... Pilot management UI */}
                </div>
                <div className="p-6 bg-slate-800 rounded-xl shadow-2xl">
                  <h2 className="text-xl font-semibold mb-4 text-sky-400">Sync Flights from API</h2>
                  {/* ... API sync UI */}
                </div>
              </div>
              
              <div className="text-center mb-6">
                <button onClick={() => setShowDutyModal(true)} className="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg" disabled={!currentPilotId}>
                  Log New Duty Manually for Selected Pilot
                </button>
              </div>
              
              <div className="mt-8">
                 <h2 className="text-2xl font-semibold mb-4 text-sky-400">Flight Duty Log for: <span className="font-bold">{pilots.find(p => p.id === currentPilotId)?.name || '...'}</span></h2>
                 {/* ... Flight log table UI ... */}
              </div>

              {/* ... All Modals (Details, Add Pilot, Add Duty) */}
            </div>
          );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
