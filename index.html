<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilot Operations Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-900 text-slate-200">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        window.firebase = {
            initializeApp, getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        
        const firebaseConfig = {
          apiKey: "AIzaSyBj6LK7FIgolevRztQ4z78YY4d9F1dlDyg",
          authDomain: "flight-duty-tracker-fbeae.firebaseapp.com",
          projectId: "flight-duty-tracker-fbeae",
          storageBucket: "flight-duty-tracker-fbeae.firebasestorage.app", 
          messagingSenderId: "430097302817",
          appId: "1:430097302817:web:ed0594f45931dc84dc6a60",
        };
        const API_BASE_URL = "https://flight-duty-proxy.onrender.com"; 
        const MAX_FLIGHT_TIME_28_DAYS = 112; 
        const MAX_FLIGHT_TIME_90_DAYS = 300; 
        const MAX_FLIGHT_TIME_365_DAYS = 1000; 
        const MIN_REST_AWAY_FROM_BASE = 10;

        const formatDateTime = (dateString) => {
          if (!dateString) return 'N/A';
          return new Date(dateString).toLocaleString('en-CA', { dateStyle: 'medium', timeStyle: 'short' });
        };
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const LoginScreen = ({ auth, setError, error }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const { signInWithEmailAndPassword } = window.firebase;

            const handleLogin = async () => {
                setIsLoading(true);
                setError('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    setError("Login failed: Invalid email or password.");
                } finally {
                    setIsLoading(false);
                }
            };
            
            return (
                <div className="flex items-center justify-center min-h-screen">
                    <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-xl shadow-2xl">
                        <div>
                            <h2 className="text-3xl font-bold text-center text-sky-400">Pilot Operations Dashboard</h2>
                            <p className="mt-2 text-center text-sm text-slate-400">Please sign in</p>
                        </div>
                        {error && <div className="bg-red-500/20 text-red-300 p-3 rounded-lg text-center">{error}</div>}
                        <div className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-slate-300">Email address</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-white shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"/>
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-slate-300">Password</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-white shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"/>
                            </div>
                            <button onClick={handleLogin} disabled={isLoading} className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 disabled:opacity-50">
                                {isLoading ? 'Signing In...' : 'Sign In'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
          const [auth, setAuth] = useState(null);
          const [user, setUser] = useState(null);
          const [isAuthReady, setIsAuthReady] = useState(false);
          const [allApiFlights, setAllApiFlights] = useState([]);
          const [pilots, setPilots] = useState([]);
          const [selectedPilotId, setSelectedPilotId] = useState('');
          const [apiFromDate, setApiFromDate] = useState(() => {
              const date = new Date();
              date.setDate(date.getDate() - 30);
              return formatDate(date);
          });
          const [apiToDate, setApiToDate] = useState(formatDate(new Date()));
          const [isApiLoading, setIsApiLoading] = useState(false);
          const [apiMessage, setApiMessage] = useState('Sync from the API to get started.');
          const [error, setError] = useState('');
          const [dashboardData, setDashboardData] = useState([]);
          
          const [liveTrackingData, setLiveTrackingData] = useState(null);
          const [showTrackingModal, setShowTrackingModal] = useState(false);
          const [isTracking, setIsTracking] = useState(false);

          useEffect(() => {
            const { initializeApp, getAuth, onAuthStateChanged } = window.firebase;
            const app = initializeApp(firebaseConfig);
            const firebaseAuth = getAuth(app);
            setAuth(firebaseAuth);
            const unsubscribe = onAuthStateChanged(firebaseAuth, (currentUser) => {
                setUser(currentUser);
                setIsAuthReady(true);
            });
            return () => unsubscribe();
          }, []);
          
          useEffect(() => {
              if (allApiFlights.length > 0 && pilots.length > 0) {
                 const now = new Date();
                 const dashboardStats = pilots.map(pilot => {
                    const pilotHistory = allApiFlights.filter(flight => flight.crew?.some(c => c.crewId === pilot.id));
                    const stats = { pilotId: pilot.id, name: pilot.name };
                    const lookbackPeriods = [
                        { days: 28, limit: MAX_FLIGHT_TIME_28_DAYS },
                        { days: 90, limit: MAX_FLIGHT_TIME_90_DAYS },
                        { days: 365, limit: MAX_FLIGHT_TIME_365_DAYS }
                    ];
                    lookbackPeriods.forEach(period => {
                        const startDate = new Date(now);
                        startDate.setDate(now.getDate() - period.days);
                        const totalHours = pilotHistory
                            .filter(entry => new Date(entry.departureTime) >= startDate)
                            .reduce((sum, entry) => sum + (entry.flightLogTime?.flight || 0), 0);
                        stats[`total${period.days}`] = totalHours;
                    });
                    return stats;
                 });
                 setDashboardData(dashboardStats);
              } else {
                  setDashboardData([]);
              }
          }, [allApiFlights, pilots]);

          const handleSignOut = async () => {
              const { signOut } = window.firebase;
              try {
                  await signOut(auth);
              } catch (e) {
                  setError("Failed to sign out.");
              }
          };

          const fetchAndProcessFlightsFromAPI = async () => {
            setIsApiLoading(true);
            setApiMessage("Fetching flights...");
            setError('');
            setAllApiFlights([]); 
            setPilots([]);
            setSelectedPilotId('');

            const endpoint = `${API_BASE_URL}/api/flights`;
            const fromDateUTC = new Date(apiFromDate).toISOString();
            const toDateUTC = new Date(new Date(apiToDate).setHours(23, 59, 59, 999)).toISOString();

            try {
              const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fromDate: fromDateUTC, toDate: toDateUTC })
              });
              const responseData = await response.json();
              if (!response.ok) throw new Error(responseData.details || responseData.message || 'Unknown proxy error');
              
              const flightsToProcess = responseData.flights || [];
              setAllApiFlights(flightsToProcess);

              if (flightsToProcess.length > 0) {
                  const pilotMap = new Map();
                  flightsToProcess.forEach(flight => {
                      if (flight.crew) {
                          flight.crew.forEach(member => {
                              if (member.crewId && !pilotMap.has(member.crewId)) {
                                  pilotMap.set(member.crewId, { id: member.crewId, name: member.name || member.crewId });
                              }
                          });
                      }
                  });
                  const uniquePilots = Array.from(pilotMap.values()).sort((a,b) => a.name.localeCompare(b.name));
                  setPilots(uniquePilots);
                  if(uniquePilots.length > 0) {
                      setSelectedPilotId(uniquePilots[0].id);
                  }
                  setApiMessage(`Successfully fetched ${flightsToProcess.length} flights.`);
              } else {
                setApiMessage("Successfully fetched, but no flights found in the date range.");
              }
            } catch (err) {
              setApiMessage(`Error: ${err.message}`);
              setError(`API Error: ${err.message}`);
            } finally {
              setIsApiLoading(false);
            }
          };

          const handleTrackLive = async (flight) => {
              if (!flight || !flight.callSign) {
                  setError("No callsign available for this flight to track.");
                  return;
              }
              setIsTracking(true);
              setLiveTrackingData(null);
              setShowTrackingModal(true);
              setError('');

              try {
                  const endpoint = `${API_BASE_URL}/api/track/${flight.callSign}`;
                  const response = await fetch(endpoint);
                  const data = await response.json();

                  if (!response.ok) {
                      throw new Error(data.details || data.message || "Failed to fetch tracking data.");
                  }

                  if (data.states && data.states.length > 0) {
                      const flightState = data.states[0];
                      setLiveTrackingData({
                          callsign: flightState[1].trim(),
                          origin: flightState[2],
                          longitude: flightState[5],
                          latitude: flightState[6],
                          altitude: flightState[7] || 'N/A',
                          on_ground: flightState[8],
                          velocity: flightState[9] ? (flightState[9] * 1.94384).toFixed(0) + ' kts' : 'N/A', // m/s to knots
                          vertical_rate: flightState[11] ? (flightState[11] * 196.85).toFixed(0) + ' fpm' : 'N/A' // m/s to fpm
                      });
                  } else {
                      setLiveTrackingData({ error: "No live ADSB data found for this callsign." });
                  }
              } catch (err) {
                  console.error("Error tracking flight:", err);
                  setLiveTrackingData({ error: `Could not track flight: ${err.message}` });
              } finally {
                  setIsTracking(false);
              }
          };

          if (!isAuthReady) {
              return <div className="flex items-center justify-center min-h-screen text-white">Loading...</div>;
          }

          if (!user) {
              return <LoginScreen auth={auth} setError={setError} error={error} />;
          }

          const displayedFlights = allApiFlights.filter(flight => 
              flight.crew?.some(c => c.crewId === selectedPilotId)
          ).sort((a,b) => new Date(b.departureTime) - new Date(a.departureTime));

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-slate-100 font-sans p-4 md:p-8">
              <header className="mb-8 text-center relative">
                <h1 className="text-4xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-500">Flight Operations Dashboard</h1>
                <p className="text-slate-400 text-sm mt-1">Logged in as: {user.email}</p>
                <div className="absolute top-0 right-0">
                    <button onClick={handleSignOut} className="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md">
                        Sign Out
                    </button>
                </div>
              </header>
              {error && <div className="bg-red-700/30 border border-red-500 text-red-300 px-4 py-3 rounded-lg mb-6"><strong className="font-bold">Error: </strong><span className="block sm:inline">{error}</span></div>}
              
              <div className="mb-6 p-6 bg-slate-800 rounded-xl shadow-2xl">
                  <h2 className="text-xl font-semibold mb-4 text-sky-400 text-center">Sync Flight Data</h2>
                  <div className="flex flex-col sm:flex-row justify-center items-end gap-4">
                      <div>
                          <label htmlFor="apiFromDate" className="block text-sm font-medium text-slate-300">From</label>
                          <input type="date" id="apiFromDate" value={apiFromDate} onChange={e => setApiFromDate(e.target.value)} required className="mt-1 bg-slate-700 border-slate-600 text-slate-100 sm:text-sm rounded-lg"/>
                      </div>
                      <div>
                          <label htmlFor="apiToDate" className="block text-sm font-medium text-slate-300">To</label>
                          <input type="date" id="apiToDate" value={apiToDate} onChange={e => setApiToDate(e.target.value)} required className="mt-1 bg-slate-700 border-slate-600 text-slate-100 sm:text-sm rounded-lg"/>
                      </div>
                      <button onClick={fetchAndProcessFlightsFromAPI} className="w-full sm:w-auto bg-purple-600 hover:bg-purple-500 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg" disabled={isApiLoading}>
                          {isApiLoading ? 'Syncing...' : 'Sync Flights from API'}
                      </button>
                  </div>
                   {apiMessage && <p className="text-center mt-4 text-slate-400 italic">{apiMessage}</p>}
              </div>
              
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-1 space-y-6">
                    <div className="p-6 bg-slate-800 rounded-xl shadow-2xl">
                        <h2 className="text-xl font-semibold mb-4 text-sky-400">Select Pilot</h2>
                         <select value={selectedPilotId} onChange={(e) => setSelectedPilotId(e.target.value)} className="bg-slate-700 border border-slate-600 text-slate-100 text-sm rounded-lg block w-full p-2.5" disabled={!pilots.length}>
                            {pilots.length > 0 ? pilots.map(p => (<option key={p.id} value={p.id}>{p.name}</option>)) : <option>Sync flights to populate pilots</option>}
                        </select>
                    </div>
                </div>

                <div className="lg:col-span-2 p-6 bg-slate-800 rounded-xl shadow-2xl">
                    <h2 className="text-xl font-semibold mb-4 text-sky-400">Flight Log for: <span className="font-bold">{pilots.find(p=>p.id === selectedPilotId)?.name || '...'}</span></h2>
                     <div className="overflow-x-auto max-h-[60vh]">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-700/50 sticky top-0">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Date & Time (UTC)</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Call Sign</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Route</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Aircraft</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Actions</th>
                            </tr>
                            </thead>
                            <tbody className="bg-slate-800 divide-y divide-slate-700">
                            {displayedFlights.length > 0 ? displayedFlights.map(flight => (
                                <tr key={flight.flightId} className="hover:bg-slate-700/70">
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-slate-200">{formatDateTime(flight.departureTime)}</td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-slate-300">{flight.callSign || 'N/A'}</td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-slate-200">{flight.departure} {'->'} {flight.destination}</td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-slate-300">{flight.aircraftRegistration}</td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm">
                                    <button onClick={() => handleTrackLive(flight)} className="text-sky-400 hover:text-sky-300 font-semibold" disabled={!flight.callSign}>Track Live</button>
                                </td>
                                </tr>
                            )) : (
                                <tr><td colSpan="5" className="px-4 py-5 text-center text-slate-400 italic">No flights to display for selected pilot.</td></tr>
                            )}
                            </tbody>
                        </table>
                    </div>
                </div>
              </div>
              
              {showTrackingModal && (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                    <div className="bg-slate-800 p-6 rounded-xl shadow-2xl w-full max-w-lg">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-2xl font-semibold text-sky-400">Live Flight Tracking</h3>
                            <button onClick={() => setShowTrackingModal(false)} className="text-slate-400 hover:text-slate-200 text-2xl font-bold">&times;</button>
                        </div>
                        {isTracking && <div className="text-center p-8">Searching for live ADSB data...</div>}
                        {!isTracking && liveTrackingData && (
                            <div className="space-y-2">
                                {liveTrackingData.error ? (
                                    <p className="text-yellow-400">{liveTrackingData.error}</p>
                                ) : (
                                    <div className="text-lg">
                                        <p><strong className="font-semibold text-slate-400 w-32 inline-block">Callsign:</strong> {liveTrackingData.callsign}</p>
                                        <p><strong className="font-semibold text-slate-400 w-32 inline-block">Status:</strong> {liveTrackingData.on_ground ? "On Ground" : "In Air"}</p>
                                        <p><strong className="font-semibold text-slate-400 w-32 inline-block">Latitude:</strong> {liveTrackingData.latitude}</p>
                                        <p><strong className="font-semibold text-slate-400 w-32 inline-block">Longitude:</strong> {liveTrackingData.longitude}</p>
                                        <p><strong className="font-semibold text-slate-400 w-32 inline-block">Altitude:</strong> {liveTrackingData.altitude} ft</p>
                                        <p><strong className="font-semibold text-slate-400 w-32 inline-block">Ground Speed:</strong> {liveTrackingData.velocity}</p>
                                        <p><strong className="font-semibold text-slate-400 w-32 inline-block">Vertical Rate:</strong> {liveTrackingData.vertical_rate}</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
              )}
            </div>
          );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
