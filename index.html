<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilot Operations Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-900 text-slate-200">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, Timestamp, setDoc, getDoc, where, getDocs, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        window.firebase = {
            initializeApp, getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,
            getFirestore, collection, addDoc, query, onSnapshot, doc, Timestamp, setDoc, getDoc, where, getDocs, orderBy, setLogLevel
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        
        const firebaseConfig = {
          apiKey: "AIzaSyBj6LK7FIgolevRztQ4z78YY4d9F1dlDyg",
          authDomain: "flight-duty-tracker-fbeae.firebaseapp.com",
          projectId: "flight-duty-tracker-fbeae",
          storageBucket: "flight-duty-tracker-fbeae.firebasestorage.app", 
          messagingSenderId: "430097302817",
          appId: "1:430097302817:web:ed0594f45931dc84dc6a60",
        };
        const API_BASE_URL = "https://flight-duty-proxy.onrender.com"; 
        const MAX_FLIGHT_TIME_28_DAYS = 112; 
        const MAX_FLIGHT_TIME_90_DAYS = 300; 
        const MAX_FLIGHT_TIME_365_DAYS = 1000; 
        const MIN_REST_AWAY_FROM_BASE = 10;

        const formatDateTime = (dateString) => {
          if (!dateString) return 'N/A';
          return new Date(dateString).toLocaleString('en-CA', { dateStyle: 'medium', timeStyle: 'short' });
        };
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const LoginScreen = ({ auth, setError, error }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const { signInWithEmailAndPassword } = window.firebase;

            const handleLogin = async () => {
                setIsLoading(true);
                setError('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    setError("Login failed: Invalid email or password.");
                } finally {
                    setIsLoading(false);
                }
            };
            
            return (
                <div className="flex items-center justify-center min-h-screen">
                    <div className="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-xl shadow-2xl">
                        <div>
                            <h2 className="text-3xl font-bold text-center text-sky-400">Pilot Operations Dashboard</h2>
                            <p className="mt-2 text-center text-sm text-slate-400">Please sign in</p>
                        </div>
                        {error && <div className="bg-red-500/20 text-red-300 p-3 rounded-lg text-center">{error}</div>}
                        <div className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-slate-300">Email address</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-white shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"/>
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-slate-300">Password</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-white shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"/>
                            </div>
                            <button onClick={handleLogin} disabled={isLoading} className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 disabled:opacity-50">
                                {isLoading ? 'Signing In...' : 'Sign In'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
          const [auth, setAuth] = useState(null);
          const [user, setUser] = useState(null);
          const [isAuthReady, setIsAuthReady] = useState(false);
          const [allApiFlights, setAllApiFlights] = useState([]);
          const [pilots, setPilots] = useState([]);
          const [selectedPilotId, setSelectedPilotId] = useState('');
          const [apiFromDate, setApiFromDate] = useState(() => {
              const date = new Date();
              date.setDate(date.getDate() - 30);
              return formatDate(date);
          });
          const [apiToDate, setApiToDate] = useState(formatDate(new Date()));
          const [isApiLoading, setIsApiLoading] = useState(false);
          const [apiMessage, setApiMessage] = useState('');
          const [error, setError] = useState('');
          const [legalityResult, setLegalityResult] = useState(null);
          const [isCheckingLegality, setIsCheckingLegality] = useState(false);
          const [dashboardData, setDashboardData] = useState([]);

          const [proposedDutyDate, setProposedDutyDate] = useState(formatDate(new Date()));
          const [proposedStartTime, setProposedStartTime] = useState('09:00');
          const [proposedEndTime, setProposedEndTime] = useState('17:00');
          const [proposedFlightTime, setProposedFlightTime] = useState('6');
          
          const [geminiNote, setGeminiNote] = useState('');
          const [isGeneratingNote, setIsGeneratingNote] = useState(false);

          useEffect(() => {
            const { initializeApp, getAuth, onAuthStateChanged } = window.firebase;
            const app = initializeApp(firebaseConfig);
            const firebaseAuth = getAuth(app);
            setAuth(firebaseAuth);
            const unsubscribe = onAuthStateChanged(firebaseAuth, (currentUser) => {
                setUser(currentUser);
                setIsAuthReady(true);
            });
            return () => unsubscribe();
          }, []);
          
          useEffect(() => {
              if (allApiFlights.length > 0) {
                 const now = new Date();
                 const dashboardStats = pilots.map(pilot => {
                    const pilotHistory = allApiFlights.filter(flight => flight.crew?.some(c => c.crewId === pilot.id));
                    const stats = { pilotId: pilot.id, name: pilot.name };
                    const lookbackPeriods = [
                        { days: 28, limit: MAX_FLIGHT_TIME_28_DAYS },
                        { days: 90, limit: MAX_FLIGHT_TIME_90_DAYS },
                        { days: 365, limit: MAX_FLIGHT_TIME_365_DAYS }
                    ];
                    lookbackPeriods.forEach(period => {
                        const startDate = new Date(now);
                        startDate.setDate(now.getDate() - period.days);
                        const totalHours = pilotHistory
                            .filter(entry => new Date(entry.departureTime) >= startDate)
                            .reduce((sum, entry) => sum + (entry.flightLogTime?.flight || 0), 0);
                        stats[`total${period.days}`] = totalHours;
                    });
                    return stats;
                 });
                 setDashboardData(dashboardStats);
              } else {
                  setDashboardData([]);
              }
          }, [allApiFlights, pilots]);

          const handleSignOut = async () => {
              const { signOut } = window.firebase;
              try {
                  await signOut(auth);
              } catch (e) {
                  setError("Failed to sign out.");
              }
          };

          const fetchAndProcessFlightsFromAPI = async () => {
            setIsApiLoading(true);
            setApiMessage("Fetching flights...");
            setError('');
            setAllApiFlights([]); 
            setPilots([]);
            setSelectedPilotId('');
            setLegalityResult(null);
            setGeminiNote('');

            const endpoint = `${API_BASE_URL}/api/flights`;
            const fromDateUTC = new Date(apiFromDate).toISOString();
            const toDateUTC = new Date(new Date(apiToDate).setHours(23, 59, 59, 999)).toISOString();

            try {
              const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fromDate: fromDateUTC, toDate: toDateUTC })
              });
              const responseData = await response.json();
              if (!response.ok) throw new Error(responseData.details || responseData.message || 'Unknown proxy error');
              
              const flightsToProcess = responseData.flights || [];
              setAllApiFlights(flightsToProcess);

              if (flightsToProcess.length > 0) {
                  const pilotMap = new Map();
                  flightsToProcess.forEach(flight => {
                      if (flight.crew) {
                          flight.crew.forEach(member => {
                              if (member.crewId && !pilotMap.has(member.crewId)) {
                                  pilotMap.set(member.crewId, { id: member.crewId, name: member.crewId });
                              }
                          });
                      }
                  });
                  const uniquePilots = Array.from(pilotMap.values()).sort((a,b) => a.name.localeCompare(b.name));
                  setPilots(uniquePilots);
                  if(uniquePilots.length > 0) {
                      setSelectedPilotId(uniquePilots[0].id);
                  }
                  setApiMessage(`Successfully fetched ${flightsToProcess.length} flights.`);
              } else {
                setApiMessage("Successfully fetched, but no flights found in the date range.");
              }
            } catch (err) {
              setApiMessage(`Error: ${err.message}`);
              setError(`API Error: ${err.message}`);
            } finally {
              setIsApiLoading(false);
            }
          };
          
          const handleLegalityCheck = async () => {
            if(!selectedPilotId) return;
            setIsCheckingLegality(true);
            setLegalityResult(null);
            setGeminiNote(''); 
            setError('');

            try {
                const pilotHistory = allApiFlights.filter(flight => 
                    flight.crew?.some(c => c.crewId === selectedPilotId)
                );

                const proposedStart = new Date(`${proposedDutyDate}T${proposedStartTime}`);
                let proposedEnd = new Date(`${proposedDutyDate}T${proposedEndTime}`);
                if(proposedEnd <= proposedStart) proposedEnd.setDate(proposedEnd.getDate() + 1);
                
                const proposedFDP = (proposedEnd - proposedStart) / (1000 * 60 * 60);
                const proposedFT = parseFloat(proposedFlightTime);
                const proposedFlights = 1;
                
                let results = [];

                const lastFlight = pilotHistory
                  .filter(f => f.flightLogTime?.timeIn || f.arrivalTime)
                  .map(f => ({ dutyEndTimestamp: new Date(f.flightLogTime?.timeIn || f.arrivalTime) }))
                  .sort((a,b) => b.dutyEndTimestamp.getTime() - a.dutyEndTimestamp.getTime())[0];

                if (lastFlight && lastFlight.dutyEndTimestamp) {
                    const restInHours = (proposedStart.getTime() - lastFlight.dutyEndTimestamp.getTime()) / (1000 * 60 * 60);
                    if(restInHours < MIN_REST_AWAY_FROM_BASE) {
                        results.push({ check: "Minimum Rest", status: "VIOLATION", details: `Required: ${MIN_REST_AWAY_FROM_BASE}h, Actual: ${restInHours.toFixed(1)}h`});
                    } else {
                        results.push({ check: "Minimum Rest", status: "OK", details: `${restInHours.toFixed(1)}h rest is sufficient.`});
                    }
                } else {
                    results.push({ check: "Minimum Rest", status: "OK", details: "No previous flights found for pilot."});
                }
                
                const maxFDP = getMaxFDP(proposedStart.toISOString(), proposedFlights);
                if(proposedFDP > maxFDP) {
                     results.push({ check: "Max FDP", status: "VIOLATION", details: `Proposed FDP: ${proposedFDP.toFixed(1)}h, Max Allowed: ${maxFDP}h`});
                } else {
                     results.push({ check: "Max FDP", status: "OK", details: `Proposed FDP: ${proposedFDP.toFixed(1)}h, Max Allowed: ${maxFDP}h`});
                }

                const lookbackPeriods = [
                    { days: 28, limit: MAX_FLIGHT_TIME_28_DAYS },
                    { days: 90, limit: MAX_FLIGHT_TIME_90_DAYS },
                    { days: 365, limit: MAX_FLIGHT_TIME_365_DAYS }
                ];

                for (const period of lookbackPeriods) {
                    const startDate = new Date(proposedStart);
                    startDate.setDate(startDate.getDate() - period.days);
                    
                    const totalPastHours = pilotHistory
                        .filter(entry => new Date(entry.departureTime) >= startDate && new Date(entry.departureTime) < proposedStart)
                        .reduce((sum, entry) => sum + (entry.flightLogTime?.flight || 0), 0);
                    
                    const futureTotal = totalPastHours + proposedFT;

                    if (futureTotal > period.limit) {
                        results.push({ check: `${period.days}-Day Flight Time`, status: "VIOLATION", details: `Projected Total: ${futureTotal.toFixed(1)}h, Limit: ${period.limit}h` });
                    } else {
                        results.push({ check: `${period.days}-Day Flight Time`, status: "OK", details: `Projected Total: ${futureTotal.toFixed(1)}h, Limit: ${period.limit}h` });
                    }
                }
                
                setLegalityResult(results);
            } catch(err) { setError("Failed to check legality.");}
            finally { setIsCheckingLegality(false); }
          };

          const handleGenerateNote = async () => {
              if (!legalityResult) {
                  setError("Please run a legality check first.");
                  return;
              }
              setIsGeneratingNote(true);
              setGeminiNote('');
              setError('');

              const selectedPilot = pilots.find(p => p.id === selectedPilotId);
              const summary = legalityResult.map(r => `- ${r.check}: ${r.status} (${r.details})`).join('\n');
              const prompt = `Act as a flight dispatcher. Write a concise briefing note for a proposed duty for pilot ${selectedPilot?.name || 'N/A'}.
              Proposed Duty Details:
              - Date: ${proposedDutyDate}
              - Start Time: ${proposedStartTime}
              - End Time: ${proposedEndTime}
              Legality Check Summary:
              ${summary}
              Based on the summary, provide a clear, one-paragraph recommendation or a note of caution for the scheduler.`;

              const endpoint = `${API_BASE_URL}/api/generate-briefing`;

              try {
                  const response = await fetch(endpoint, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ prompt })
                  });
                  
                  const contentType = response.headers.get("content-type");
                  if (!response.ok || !contentType || !contentType.includes("application/json")) {
                      const errorText = await response.text();
                      console.error("Proxy Server Error:", errorText);
                      throw new Error("The proxy server returned an unexpected error. Please check the Render logs.");
                  }

                  const result = await response.json();
                  if (result.error) {
                      throw new Error(result.error?.message || "Gemini API returned an error.");
                  }

                  if (result.candidates && result.candidates.length > 0 && result.candidates[0].content?.parts?.[0]?.text) {
                      setGeminiNote(result.candidates[0].content.parts[0].text);
                  } else {
                      throw new Error("Invalid response structure from Gemini API.");
                  }
              } catch (err) {
                  console.error("Error calling Gemini API via proxy:", err);
                  setError(`Failed to generate note: ${err.message}`);
              } finally {
                  setIsGeneratingNote(false);
              }
          };

          if (!isAuthReady) {
              return <div className="flex items-center justify-center min-h-screen text-white">Loading...</div>;
          }

          if (!user) {
              return <LoginScreen auth={auth} setError={setError} error={error} />;
          }

          const displayedFlights = allApiFlights.filter(flight => 
              flight.crew?.some(c => c.crewId === selectedPilotId)
          ).sort((a,b) => new Date(b.departureTime) - new Date(a.departureTime));

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-slate-100 font-sans p-4 md:p-8">
              <header className="mb-8 text-center relative">
                <h1 className="text-4xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-500">Flight Operations Dashboard</h1>
                <p className="text-slate-400 text-sm mt-1">Logged in as: {user.email}</p>
                <div className="absolute top-0 right-0">
                    <button onClick={handleSignOut} className="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md">
                        Sign Out
                    </button>
                </div>
              </header>
              {error && <div className="bg-red-700/30 border border-red-500 text-red-300 px-4 py-3 rounded-lg mb-6"><strong className="font-bold">Error: </strong><span className="block sm:inline">{error}</span></div>}
              
              <div className="mb-6 p-6 bg-slate-800 rounded-xl shadow-2xl">
                  <h2 className="text-xl font-semibold mb-4 text-sky-400 text-center">Sync Flight Data</h2>
                  <div className="flex flex-col sm:flex-row justify-center items-end gap-4">
                      <div>
                          <label htmlFor="apiFromDate" className="block text-sm font-medium text-slate-300">From</label>
                          <input type="date" id="apiFromDate" value={apiFromDate} onChange={e => setApiFromDate(e.target.value)} required className="mt-1 bg-slate-700 border-slate-600 text-slate-100 sm:text-sm rounded-lg"/>
                      </div>
                      <div>
                          <label htmlFor="apiToDate" className="block text-sm font-medium text-slate-300">To</label>
                          <input type="date" id="apiToDate" value={apiToDate} onChange={e => setApiToDate(e.target.value)} required className="mt-1 bg-slate-700 border-slate-600 text-slate-100 sm:text-sm rounded-lg"/>
                      </div>
                      <button onClick={fetchAndProcessFlightsFromAPI} className="w-full sm:w-auto bg-purple-600 hover:bg-purple-500 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg" disabled={isApiLoading}>
                          {isApiLoading ? 'Syncing...' : 'Sync Flights from API'}
                      </button>
                  </div>
                   {apiMessage && <p className="text-center mt-4 text-slate-400 italic">{apiMessage}</p>}
              </div>

              <div className="mb-6 p-6 bg-slate-800 rounded-xl shadow-2xl">
                <h2 className="text-xl font-semibold text-center text-sky-400 mb-4">Crew Status Dashboard</h2>
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-slate-700">
                        <thead className="bg-slate-700/50">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Pilot</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Last 28 Days</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Last 90 Days</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Last 365 Days</th>
                            </tr>
                        </thead>
                        <tbody className="bg-slate-800 divide-y divide-slate-700">
                            {dashboardData.length > 0 ? dashboardData.map(pilotStats => {
                                const p28 = (pilotStats.total28 / MAX_FLIGHT_TIME_28_DAYS) * 100;
                                const p90 = (pilotStats.total90 / MAX_FLIGHT_TIME_90_DAYS) * 100;
                                const p365 = (pilotStats.total365 / MAX_FLIGHT_TIME_365_DAYS) * 100;

                                const getColor = (percentage) => {
                                    if (percentage > 90) return 'text-red-400';
                                    if (percentage > 75) return 'text-yellow-400';
                                    return 'text-green-400';
                                };

                                return (
                                    <tr key={pilotStats.pilotId}>
                                        <td className="px-4 py-4 whitespace-nowrap text-sm font-medium text-slate-200">{pilotStats.name}</td>
                                        <td className={`px-4 py-4 whitespace-nowrap text-sm font-semibold ${getColor(p28)}`}>{pilotStats.total28.toFixed(1)} / {MAX_FLIGHT_TIME_28_DAYS}h</td>
                                        <td className={`px-4 py-4 whitespace-nowrap text-sm font-semibold ${getColor(p90)}`}>{pilotStats.total90.toFixed(1)} / {MAX_FLIGHT_TIME_90_DAYS}h</td>
                                        <td className={`px-4 py-4 whitespace-nowrap text-sm font-semibold ${getColor(p365)}`}>{pilotStats.total365.toFixed(1)} / {MAX_FLIGHT_TIME_365_DAYS}h</td>
                                    </tr>
                                )
                            }) : (
                                <tr><td colSpan="4" className="px-4 py-5 text-center text-slate-400 italic">No pilot data to display. Sync from API to populate.</td></tr>
                            )}
                        </tbody>
                    </table>
                </div>
              </div>
              
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-1 space-y-6">
                    <div className="p-6 bg-slate-800 rounded-xl shadow-2xl">
                        <h2 className="text-xl font-semibold mb-4 text-sky-400">Select Pilot</h2>
                         <select value={selectedPilotId} onChange={(e) => { setSelectedPilotId(e.target.value); setLegalityResult(null); setGeminiNote('') }} className="bg-slate-700 border border-slate-600 text-slate-100 text-sm rounded-lg block w-full p-2.5" disabled={!pilots.length}>
                            {pilots.length > 0 ? pilots.map(p => (<option key={p.id} value={p.id}>{p.name}</option>)) : <option>Sync flights to populate pilots</option>}
                        </select>
                    </div>

                    <div className="p-6 bg-slate-800 rounded-xl shadow-2xl space-y-4">
                        <h2 className="text-xl font-semibold text-sky-400">Propose Future Flight</h2>
                        <div>
                            <label className="block text-sm font-medium text-slate-300">Date</label>
                            <input type="date" value={proposedDutyDate} onChange={e => setProposedDutyDate(e.target.value)} className="mt-1 bg-slate-700 border-slate-600 w-full p-2 rounded-md"/>
                        </div>
                        <div className="flex gap-4">
                            <div className="flex-1">
                                <label className="block text-sm font-medium text-slate-300">Start Time</label>
                                <input type="time" value={proposedStartTime} onChange={e => setProposedStartTime(e.target.value)} className="mt-1 bg-slate-700 border-slate-600 w-full p-2 rounded-md"/>
                            </div>
                             <div className="flex-1">
                                <label className="block text-sm font-medium text-slate-300">End Time</label>
                                <input type="time" value={proposedEndTime} onChange={e => setProposedEndTime(e.target.value)} className="mt-1 bg-slate-700 border-slate-600 w-full p-2 rounded-md"/>
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-300">Proposed Flight Time (Hours)</label>
                            <input type="number" value={proposedFlightTime} onChange={e => setProposedFlightTime(e.target.value)} className="mt-1 bg-slate-700 border-slate-600 w-full p-2 rounded-md"/>
                        </div>
                         <button onClick={handleLegalityCheck} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg" disabled={isCheckingLegality || !selectedPilotId}>
                            {isCheckingLegality ? 'Checking...' : 'Check Legality'}
                        </button>
                        {legalityResult && (
                            <div className="mt-4 pt-4 border-t border-slate-700/50">
                                <h3 className="font-bold text-lg mb-2">Legality Results:</h3>
                                <ul className="space-y-1">
                                    {legalityResult.map((res, index) => (
                                        <li key={index} className={`flex justify-between p-2 rounded-md ${res.status === 'OK' ? 'bg-green-500/10 text-green-300' : 'bg-red-500/20 text-red-300'}`}>
                                            <span className="font-semibold">{res.check}:</span>
                                            <span>{res.details}</span>
                                        </li>
                                    ))}
                                </ul>
                                <button onClick={handleGenerateNote} disabled={isGeneratingNote} className="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-2.5 px-6 rounded-lg shadow-lg disabled:opacity-50">
                                    {isGeneratingNote ? 'Generating...' : 'âœ¨ Generate Briefing Note'}
                                </button>
                            </div>
                        )}
                        {geminiNote && (
                             <div className="mt-4 p-4 bg-slate-900/70 rounded-lg">
                                <h3 className="font-bold text-lg mb-2 text-amber-400">AI Briefing Note:</h3>
                                <p className="text-slate-300 whitespace-pre-wrap">{geminiNote}</p>
                            </div>
                        )}
                    </div>
                </div>

                <div className="lg:col-span-2 p-6 bg-slate-800 rounded-xl shadow-2xl">
                    <h2 className="text-xl font-semibold mb-4 text-sky-400">Flight Log for: <span className="font-bold">{pilots.find(p=>p.id === selectedPilotId)?.name || '...'}</span></h2>
                     <div className="overflow-x-auto max-h-[60vh]">
                        <table className="min-w-full divide-y divide-slate-700">
                            <thead className="bg-slate-700/50 sticky top-0">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Date & Time (UTC)</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Call Sign</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Route</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Aircraft</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Block / Flight (H)</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">Crew</th>
                            </tr>
                            </thead>
                            <tbody className="bg-slate-800 divide-y divide-slate-700">
                            {displayedFlights.length > 0 ? displayedFlights.map(flight => (
                                <tr key={flight.flightId} className="hover:bg-slate-700/70">
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-slate-200">{formatDateTime(flight.departureTime)}</td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-slate-300">{flight.callSign || 'N/A'}</td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-slate-200">{flight.departure} {'->'} {flight.destination}</td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-slate-300">{flight.aircraftRegistration}</td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-slate-300">
                                    {flight.flightLogTime?.block ? flight.flightLogTime.block.toFixed(1) : 'N/A'} / {flight.flightLogTime?.flight ? flight.flightLogTime.flight.toFixed(1) : 'N/A'}
                                </td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-slate-300">{flight.crew?.map(c => c.crewId.split('@')[0]).join(', ') || 'N/A'}</td>
                                </tr>
                            )) : (
                                <tr><td colSpan="6" className="px-4 py-5 text-center text-slate-400 italic">No flights to display for selected pilot.</td></tr>
                            )}
                            </tbody>
                        </table>
                    </div>
                </div>
              </div>
            </div>
          );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
